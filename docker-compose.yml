###############################################################################
# Social Feed System — Local Development Stack
#
# Starts all infrastructure AND application services in one command.
# TiDB is replaced by MySQL 8.0 (wire-compatible) for local simplicity.
#
# Usage:
#   docker compose up -d          # start everything
#   docker compose logs -f api    # tail logs
#   docker compose down -v        # teardown (removes volumes)
###############################################################################

version: "3.9"

networks:
  feed-net:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  qdrant-data:
  minio-data:
  kafka-data:
  zookeeper-data:
  pinot-data:
  feast-data:           # Feast registry (registry.db) + Parquet offline store

# ─────────────────────────── Infrastructure ───────────────────────────────
services:

  # ── MySQL (TiDB drop-in for local dev) ───────────────────────────────────
  tidb:
    image: mysql:8.0
    container_name: tidb
    environment:
      MYSQL_ROOT_PASSWORD: ""
      MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
      MYSQL_DATABASE: social_feed
    ports:
      - "4000:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - feed-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ── Redis ─────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - feed-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # ── Zookeeper (required by Kafka and Pinot) ───────────────────────────────
  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper
    networks:
      - feed-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ── Kafka ─────────────────────────────────────────────────────────────────
  kafka:
    image: confluentinc/cp-kafka:7.7.1
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Internal address (service-to-service) and external (host machine)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CREATE_TOPICS: "new-posts:3:1,impressions:3:1"
    ports:
      - "29092:29092"
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - feed-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ── Qdrant ────────────────────────────────────────────────────────────────
  qdrant:
    image: qdrant/qdrant:v1.12.4
    container_name: qdrant
    ports:
      - "6333:6333"   # REST
      - "6334:6334"   # gRPC
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - feed-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "grep -qE ':18BD ' /proc/net/tcp6 /proc/net/tcp 2>/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ── MinIO ─────────────────────────────────────────────────────────────────
  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web console
    volumes:
      - minio-data:/data
    networks:
      - feed-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ── Apache Pinot ──────────────────────────────────────────────────────────
  # Single-node quickstart; splits into Controller + Broker + Server
  pinot-controller:
    image: apachepinot/pinot:1.2.0
    container_name: pinot-controller
    command: StartController -zkAddress zookeeper:2181
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9002:9000"   # Controller UI (mapped to 9002 to avoid clash with MinIO)
    volumes:
      - pinot-data:/opt/pinot/data
    networks:
      - feed-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 20s
      timeout: 10s
      retries: 15

  pinot-broker:
    image: apachepinot/pinot:1.2.0
    container_name: pinot-broker
    command: StartBroker -zkAddress zookeeper:2181
    depends_on:
      pinot-controller:
        condition: service_healthy
    ports:
      - "8099:8099"
    networks:
      - feed-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 20s
      timeout: 10s
      retries: 15

  pinot-server:
    image: apachepinot/pinot:1.2.0
    container_name: pinot-server
    command: StartServer -zkAddress zookeeper:2181
    depends_on:
      pinot-broker:
        condition: service_healthy
    networks:
      - feed-net

  # ── Jaeger (all-in-one: collector + UI) ──────────────────────────────────
  jaeger:
    image: jaegertracing/all-in-one:1.62.0
    container_name: jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
    networks:
      - feed-net

  # ── Prometheus ────────────────────────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - feed-net
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=7d"

  # ── Grafana ───────────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:11.3.1
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3000:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - feed-net
    depends_on:
      - prometheus

# ─────────────────────── Feast Feature Store ──────────────────────────────

  feast-feature-store:
    build:
      context: ./services/feature-store
      dockerfile: Dockerfile
    container_name: feast-feature-store
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      TIDB_HOST: tidb
      TIDB_PORT: 3306
      TIDB_DATABASE: social_feed
    ports:
      - "6566:6566"   # Feast HTTP Feature Server
    volumes:
      - feast-data:/feature-repo/data   # persists registry.db + parquet snapshots
    depends_on:
      redis:
        condition: service_healthy
      tidb:
        condition: service_healthy
    networks:
      - feed-net
    healthcheck:
      test: ["CMD", "python3", "-c",
             "import urllib.request; urllib.request.urlopen('http://localhost:6566/health')"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 45s
    restart: unless-stopped

# ─────────────────────────── Application Services ─────────────────────────

  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: api
    env_file: .env
    environment:
      TIDB_HOST: tidb
      TIDB_PORT: 3306    # MySQL default (mapped from 4000 on host)
      REDIS_HOST: redis
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      QDRANT_HOST: qdrant
      MINIO_ENDPOINT: minio:9000
      PINOT_BROKER_HOST: pinot-broker
      RANKING_SERVICE_URL: http://ranking-service:8001
      FEAST_SERVER_URL: http://feast-feature-store:6566
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      ENVIRONMENT: development
    ports:
      - "8000:8000"
    depends_on:
      tidb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      minio:
        condition: service_healthy
      feast-feature-store:
        condition: service_healthy
    networks:
      - feed-net
    restart: unless-stopped

  embedding-worker:
    build:
      context: ./services/embedding-worker
      dockerfile: Dockerfile
    container_name: embedding-worker
    env_file: .env
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      QDRANT_HOST: qdrant
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    depends_on:
      kafka:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - feed-net
    restart: unless-stopped

  fanout-worker:
    build:
      context: ./services/fanout-worker
      dockerfile: Dockerfile
    container_name: fanout-worker
    env_file: .env
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      TIDB_HOST: tidb
      TIDB_PORT: 3306
      REDIS_HOST: redis
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    depends_on:
      kafka:
        condition: service_healthy
      tidb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - feed-net
    restart: unless-stopped

  ranking-service:
    build:
      context: ./services/ranking-service
      dockerfile: Dockerfile
    container_name: ranking-service
    env_file: .env
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    ports:
      - "8001:8001"
    networks:
      - feed-net
    restart: unless-stopped
